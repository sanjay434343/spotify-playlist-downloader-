<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Playlist Downloader</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
:root{
  --bg:#121212;
  --surface:#1e1e1e;
  --surface2:#242424;
  --surfaceActive:#221a3d;
  --text:#fff;
  --sub:#b3b3b3;
  --accent:#7C4DFF; /* PURPLE */
}
*{box-sizing:border-box}

body{
  margin:0;
  font-family:'Varela Round',system-ui;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:900px;
  margin:auto;
  padding:20px 20px 180px;
}

/* HEADER */
.header{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
}
.header-title{font-size:26px;font-weight:700}
.header-sub{font-size:13px;color:var(--sub)}

select{
  background:var(--surface2);
  color:white;
  border:none;
  border-radius:8px;
  padding:8px 10px;
}

/* LIST */
.list{
  margin-top:16px;
  display:flex;
  flex-direction:column;
  gap:1px;
}

/* LIST ANIMATION */
@keyframes listEnter{
  from{opacity:0;transform:translateY(14px)}
  to{opacity:1;transform:translateY(0)}
}

.card{
  background:var(--surface);
  padding:12px;
  display:flex;
  gap:12px;
  align-items:flex-start;
  animation:listEnter .45s cubic-bezier(.2,.8,.2,1) forwards;
  opacity:0;
}

.card:first-child{border-radius:20px 20px 0 0}
.card:last-child{border-radius:0 0 20px 20px}
.card:only-child{border-radius:20px}

.card.playing{
  background:var(--surfaceActive);
  border-radius:50px !important;
}

/* IMAGE */
.card img{
  width:48px;height:48px;
  border-radius:50%;
  object-fit:cover;
}

/* TEXT */
.card-info{flex:1;min-width:0}
.title,.meta{
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.title{font-size:14px;font-weight:600}
.meta{font-size:12px;color:var(--sub);margin-top:4px}

/* PLAY BUTTON */
.play-wrap{
  width:42px;height:42px;
  border-radius:50%;
  background:var(--surface2);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.play-wrap.playing{background:var(--accent)}
.play-wrap .material-icons{
  font-size:26px;
  color:var(--accent);
}
.play-wrap.playing .material-icons{color:#000}

/* FLOATING BUTTONS */
.fab,
.download-all{
  position:fixed;
  right:24px;
  width:56px;height:56px;
  border-radius:50%;
  background:var(--accent);
  border:none;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 6px 16px rgba(0,0,0,.4);
  cursor:pointer;
}

.fab{bottom:24px;font-size:28px}
.download-all{bottom:92px;display:none}

.download-all .material-icons{
  font-size:26px;
  color:#000;
}

/* BOTTOM SHEET */
.sheet{
  position:fixed;
  left:0;right:0;bottom:-100%;
  background:var(--surface);
  padding:20px;
  border-radius:20px 20px 0 0;
  transition:.35s;
}
.sheet.open{bottom:0}
.sheet input,.sheet button{
  width:100%;
  padding:12px;
  border-radius:8px;
  border:none;
  margin-bottom:12px;
}
.sheet input{background:var(--surface2);color:white}
.sheet button{background:var(--accent);color:#000}
</style>
</head>

<body>

<div class="container">
  <div class="header">
    <div>
      <div class="header-title">Playlist</div>
      <div class="header-sub" id="trackCount">No playlist loaded</div>
    </div>
    <select id="quality">
      <option value="12kbps">12 kbps</option>
      <option value="48kbps">48 kbps</option>
      <option value="96kbps">96 kbps</option>
      <option value="160kbps" selected>160 kbps</option>
      <option value="320kbps">320 kbps</option>
    </select>
  </div>

  <div class="list" id="tracks"></div>
</div>

<button class="download-all" id="downloadAll">
  <span class="material-icons">download</span>
</button>

<button class="fab" id="fab">+</button>

<div class="sheet" id="sheet">
  <input id="playlistUrl" placeholder="Paste Spotify playlist URL">
  <button id="loadBtn">Load</button>
</div>

<audio id="player"></audio>

<script>
const SPOTIFY_API = "https://spotify-api-6yog.vercel.app/api/scrape";
const SAAVN_API = "https://jiosavan-api-with-playlist.vercel.app/api/search/songs";

const tracksDiv = document.getElementById("tracks");
const trackCount = document.getElementById("trackCount");
const player = document.getElementById("player");
const qualitySelect = document.getElementById("quality");
const downloadBtn = document.getElementById("downloadAll");

let currentSongKey=null;
let currentCard=null;
const saavnCache={};

fab.onclick = () => sheet.classList.add("open");

function getPlaylistId(url){
  try{return new URL(url).pathname.split("/playlist/")[1]}catch{return null}
}

async function prefetchSaavn(key){
  const res = await fetch(`${SAAVN_API}?query=${encodeURIComponent(key)}&limit=1`);
  const json = await res.json();
  saavnCache[key] = json?.data?.results?.[0]?.downloadUrl || [];
}

loadBtn.onclick = async () => {
  const id = getPlaylistId(playlistUrl.value.trim());
  if(!id) return;

  sheet.classList.remove("open");
  tracksDiv.innerHTML="";
  downloadBtn.style.display="none";

  const res = await fetch(`${SPOTIFY_API}?playlist=${id}`);
  const data = await res.json();

  const validTracks = data.tracks.filter(t =>
    (t.title||"").trim() || (t.artists||"").trim()
  );

  trackCount.textContent = `${validTracks.length} tracks`;

  await Promise.all(
    validTracks.map(t => prefetchSaavn(`${t.title} ${t.artists}`))
  );

  downloadBtn.style.display="flex";

  validTracks.forEach((t,i)=>{
    const key = `${t.title} ${t.artists}`;

    const card=document.createElement("div");
    card.className="card";
    card.style.animationDelay=`${i*45}ms`;

    card.innerHTML=`
      <img src="${t.image}">
      <div class="card-info">
        <div class="title">${t.title}</div>
        <div class="meta">${t.artists}</div>
      </div>
      <div class="play-wrap">
        <span class="material-icons">play_arrow</span>
      </div>
    `;

    const playBtn=card.querySelector(".play-wrap");
    const icon=playBtn.querySelector(".material-icons");

    playBtn.onclick=()=>{
      if(currentSongKey===key){
        if(player.paused){
          player.play();
          icon.textContent="pause";
          playBtn.classList.add("playing");
          card.classList.add("playing");
        }else{
          player.pause();
          icon.textContent="play_arrow";
          playBtn.classList.remove("playing");
          card.classList.remove("playing");
        }
        return;
      }

      if(currentCard){
        currentCard.classList.remove("playing");
        currentCard.querySelector(".play-wrap").classList.remove("playing");
        currentCard.querySelector(".material-icons").textContent="play_arrow";
      }

      const urls=saavnCache[key];
      const q=qualitySelect.value;
      const url=urls.find(u=>u.quality===q)?.url || urls.at(-1)?.url;
      if(!url) return;

      player.src=url;
      player.play();

      icon.textContent="pause";
      playBtn.classList.add("playing");
      card.classList.add("playing");

      currentSongKey=key;
      currentCard=card;
    };

    tracksDiv.appendChild(card);
  });
};

/* ðŸ”¥ ADVANCED FORCED DOWNLOAD (BLOB) */
downloadBtn.onclick = async () => {
  const q = qualitySelect.value;

  for(const [song,urls] of Object.entries(saavnCache)){
    const fileUrl = urls.find(u=>u.quality===q)?.url;
    if(!fileUrl) continue;

    try{
      const res = await fetch(fileUrl);
      const blob = await res.blob();

      const blobUrl = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = blobUrl;
      a.download = `${song}.mp4`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(blobUrl);

      await new Promise(r=>setTimeout(r,400));
    }catch(e){
      console.error("Download failed:",song,e);
    }
  }
};
</script>

</body>
</html>
