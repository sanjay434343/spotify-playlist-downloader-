<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Playlist Downloader</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
:root{
  --bg:#121212;
  --surface:#1e1e1e;
  --surface2:#242424;
  --surfaceActive:#221a3d;
  --text:#fff;
  --sub:#b3b3b3;
  --accent:#7C4DFF;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:'Varela Round',system-ui;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:900px;
  margin:auto;
  padding:20px 20px 180px;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
}
.header-title{font-size:26px;font-weight:700}
.header-sub{font-size:13px;color:var(--sub)}

select{
  background:var(--surface2);
  color:white;
  border:none;
  border-radius:8px;
  padding:8px 10px;
}

.list{margin-top:16px}

.download-all{
  position:fixed;
  right:24px;
  bottom:92px;
  width:56px;height:56px;
  border-radius:50%;
  background:var(--accent);
  border:none;
  display:none;
  align-items:center;
  justify-content:center;
  box-shadow:0 6px 16px rgba(0,0,0,.4);
  cursor:pointer;
  color:#000;
}

.progress-text{
  font-size:12px;
  font-weight:700;
}

.fab{
  position:fixed;
  right:24px;
  bottom:24px;
  width:56px;height:56px;
  border-radius:50%;
  background:var(--accent);
  border:none;
  font-size:28px;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="container">
  <div class="header">
    <div>
      <div class="header-title">Playlist</div>
      <div class="header-sub" id="trackCount">No playlist loaded</div>
    </div>
    <select id="quality">
      <option value="96kbps">96 kbps</option>
      <option value="160kbps" selected>160 kbps</option>
      <option value="320kbps">320 kbps</option>
    </select>
  </div>
</div>

<button class="download-all" id="downloadAll">
  <span class="progress-text" id="progressText">0%</span>
</button>

<button class="fab" id="fab">+</button>

<audio id="player"></audio>

<script>
const SPOTIFY_API = "https://spotify-api-6yog.vercel.app/api/scrape";
const SAAVN_API = "https://jiosavan-api-with-playlist.vercel.app/api/search/songs";

const downloadBtn = document.getElementById("downloadAll");
const progressText = document.getElementById("progressText");
const qualitySelect = document.getElementById("quality");

const fileStore = new Map(); // filename -> Blob
const saavnCache = {};

function getPlaylistId(url){
  try{return new URL(url).pathname.split("/playlist/")[1]}catch{return null}
}

async function prefetchSaavn(key){
  const res = await fetch(`${SAAVN_API}?query=${encodeURIComponent(key)}&limit=1`);
  const json = await res.json();
  saavnCache[key] = json?.data?.results?.[0]?.downloadUrl || [];
}

/* ===============================
   DOWNLOAD → MEMORY → SAVE
================================ */
downloadBtn.onclick = async () => {
  const q = qualitySelect.value;

  let totalBytes = 0;
  let downloaded = 0;

  downloadBtn.style.display = "flex";
  progressText.textContent = "0%";

  // 1️⃣ Calculate total size
  for (const urls of Object.values(saavnCache)) {
    const u = urls.find(x => x.quality === q)?.url;
    if (!u) continue;
    const h = await fetch(u, { method: "HEAD" });
    const len = h.headers.get("content-length");
    if (len) totalBytes += +len;
  }

  // 2️⃣ Download all into memory
  for (const [song, urls] of Object.entries(saavnCache)) {
    const fileUrl = urls.find(x => x.quality === q)?.url;
    if (!fileUrl) continue;

    const res = await fetch(fileUrl);
    const reader = res.body.getReader();
    const chunks = [];

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      chunks.push(value);
      downloaded += value.length;
      progressText.textContent = `${Math.floor((downloaded / totalBytes) * 100)}%`;
    }

    const blob = new Blob(chunks);
    fileStore.set(`${song}.mp4`, blob);
  }

  progressText.textContent = "Saving…";

  // 3️⃣ Ask user ONCE where to save
  const dirHandle = await window.showDirectoryPicker();

  for (const [name, blob] of fileStore) {
    const fileHandle = await dirHandle.getFileHandle(name, { create: true });
    const writable = await fileHandle.createWritable();
    await writable.write(blob);
    await writable.close();
  }

  progressText.textContent = "Done";
};
</script>

</body>
</html>
